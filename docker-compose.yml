version: '3.8'

services:
  # Billing Service (SOAP + REST backend)
  billing-service:
    build: ../billing-service
    container_name: billing-service
    ports:
      - "8081:8081"
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SERVER_PORT=8081
    networks:
      - integration-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/billing/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # BRVM Scraper Service
  brvm-scraper:
    build: ../brvm-scraper-service
    container_name: brvm-scraper
    ports:
      - "5000:5000"
    environment:
      - FLASK_ENV=production
    networks:
      - integration-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # WSO2 Micro Integrator
  wso2mi:
    image: wso2/wso2mi:4.2.0
    container_name: wso2-micro-integrator
    ports:
      - "8290:8290"  # HTTP transport
      - "8253:8253"  # HTTPS transport
      - "9164:9164"  # Management API
    volumes:
      - ./src/api:/home/wso2carbon/wso2mi-4.2.0/repository/deployment/server/synapse-configs/default/api
      - ./src/endpoints:/home/wso2carbon/wso2mi-4.2.0/repository/deployment/server/synapse-configs/default/endpoints
      - ./src/sequences:/home/wso2carbon/wso2mi-4.2.0/repository/deployment/server/synapse-configs/default/sequences
      - ./deployment.toml:/home/wso2carbon/wso2mi-4.2.0/conf/deployment.toml
    networks:
      - integration-network
    depends_on:
      billing-service:
        condition: service_healthy
      brvm-scraper:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8290/api/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    environment:
      - JAVA_OPTS=-Xms512m -Xmx1024m

networks:
  integration-network:
    driver: bridge
